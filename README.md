# å‰è¨€

ç°åœ¨å¾®å‰ç«¯çš„æ¶æ„ååˆ†æµè¡Œï¼Œä¸ºäº†è·Ÿä¸Šå‰ç«¯é«˜é€Ÿå‘å±•çš„æ­¥ä¼ï¼Œé€šè¿‡æœ¬ç¯‡æ–‡ç« åˆæ¢ä¸€ä¸‹å¾®å‰ç«¯æ¶æ„åˆ°åº•æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ç§æ¶æ„æ¨¡å¼

# å¾®å‰ç«¯æ˜¯ä»€ä¹ˆï¼Ÿ

é¦–å…ˆé€šè¿‡[micro-frontends.org](https://micro-frontends.org/)è¿™ä¸ªç½‘ç«™èƒ½å¤Ÿäº†è§£åˆ°ä¸€äº›å…³äºå¾®å‰ç«¯æ¦‚å¿µçš„èµ·æºï¼Œè®©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£å¾®å‰ç«¯çš„æ„ä¹‰

> The idea behind Micro Frontends is to think about a website or web app asÂ **a composition of features**Â which are owned byÂ **independent teams**.
>
> Each team has aÂ **distinct area of business**Â orÂ **mission**Â it cares about and specialises in.
>
> A team isÂ **cross functional**Â and develops its featuresÂ **end-to-end**, from database to user interface.
>
> å¾®å‰ç«¯èƒŒåçš„æ€æƒ³æ˜¯è®¤ä¸ºï¼šç°ä»£å¤æ‚çš„ web app æˆ–è€…ç½‘ç«™ï¼Œé€šå¸¸ç”±å¾ˆå¤š Â **ç›¸å¯¹ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ç»„åˆè€Œæˆ**ï¼Œè€Œå¯¹è¿™äº›æ¨¡å—è´Ÿè´£çš„åº”è¯¥æ˜¯ Â **ç›¸äº’ç‹¬ç«‹çš„å¤šä¸ªå›¢é˜Ÿ**ã€‚
>
> è¿™äº›ç‹¬ç«‹çš„å›¢é˜Ÿç”±äºä¸“ä¸šåˆ†å·¥ä¸åŒï¼Œä¼šè´Ÿè´£ç€ Â **ç‰¹å®šçš„ä¸šåŠ¡é¢†åŸŸ**ï¼Œä»¥åŠå®Œæˆ Â **ç‰¹å®šçš„å¼€å‘ä»»åŠ¡**ã€‚
>
> è¿™æ ·çš„å›¢é˜Ÿï¼Œé€šå¸¸åœ¨äººå‘˜ç»„æˆæ–¹é¢å›Šæ‹¬äº†ä»å‰ç«¯å¼€å‘åˆ°æœåŠ¡ç«¯å¼€å‘ï¼Œä» UI å®ç°åˆ°æ•°æ®åº“è®¾è®¡è¿™æ · Â **ç«¯åˆ°ç«¯**Â  çš„ Â **è·¨èŒèƒ½äººå‘˜**Â  æ„æˆã€‚

é€šè¿‡è¯¥ç½‘ç«™ä¸­å¯¹å¾®å‰ç«¯æ¦‚å¿µçš„è§£é‡Šï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå¾®å‰ç«¯æ˜¯åç«¯ä¸­å¾®æœåŠ¡çš„æ€æƒ³åœ¨å‰ç«¯é¢†åŸŸçš„åº”ç”¨ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯å°†ä¸€ä¸ªé¡¹ç›®æ‹†åˆ†æˆå¤šä¸ª`ç›¸å¯¹ç‹¬ç«‹`çš„åŠŸèƒ½æ¨¡å—ï¼Œå¹¶ä¸”æ¯ä¸ªæ¨¡å—ä¹Ÿæœ‰ç€`ç›¸äº’ç‹¬ç«‹`çš„å›¢é˜Ÿå»è´Ÿè´£

å¯ä»¥çœ‹åˆ°ï¼Œååˆ†å¼ºè°ƒæ¨¡å—åŒ–ä¸å›¢é˜Ÿä¹‹é—´çš„ç‹¬ç«‹æ€§ï¼Œæ¯ä¸ªå›¢é˜Ÿåªè´Ÿè´£ä¸“æ”»è‡ªå·±æ“…é•¿çš„éƒ¨åˆ†ï¼Œå°†è‡ªå·±è´Ÿè´£çš„æ¨¡å—åŠŸèƒ½åšåˆ°æœ€å¥½ï¼Œæœ€åå°†å„ä¸ªæ¨¡å—æ•´åˆåœ¨ä¸€èµ·å˜æˆæœ€ç»ˆçš„äº§å“äº¤ä»˜å‡ºå»ï¼Œè¿™æ˜¯å¾®å‰ç«¯çš„åŸºæœ¬æ¦‚å¿µ

å¾®å‰ç«¯æ¦‚å¿µçš„æå‡ºï¼Œå°†å¾®æœåŠ¡è¿™ä¸ªè¢«å¹¿æ³›åº”ç”¨äºåç«¯çš„æŠ€æœ¯èŒƒå¼æ‰©å±•åˆ°äº†å‰ç«¯é¢†åŸŸ

# å¾®å‰ç«¯æ¶æ„èƒŒåçš„æ ¸å¿ƒæ€æƒ³

ç½‘ç«™ä¸­æ€»ç»“äº†å‡ ç‚¹å¾®å‰ç«¯æ¶æ„èƒŒåçš„æ ¸å¿ƒæ€æƒ³ï¼Œåˆ†åˆ«ä¸º

1. `Be Technology Agnostic` -- å›¢é˜Ÿä¹‹é—´å±è”½æŠ€æœ¯ç»†èŠ‚ï¼Œå„å›¢é˜Ÿä½¿ç”¨å„è‡ªæ“…é•¿çš„æŠ€æœ¯æ ˆï¼Œæ— éœ€ä¸å…¶ä»–å›¢é˜Ÿçš„æŠ€æœ¯æ ˆä¿æŒä¸€è‡´
2. `Isolate Team Code` -- å„æ¨¡å—ä¹‹é—´ä¸åº”å½“ä½¿ç”¨åŒä¸€ä¸ªè¿è¡Œæ—¶ï¼Œä¸è¦ä¾èµ–å…±äº«çš„çŠ¶æ€å’Œå…¨å±€å˜é‡
3. `Establish Team Prefixes` -- å„å›¢é˜Ÿè¦æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œæ¯”å¦‚ cssã€è‡ªå®šä¹‰äº‹ä»¶ã€localStorage å’Œ cookie ç­‰æœ‰å¯èƒ½æ¶‰åŠåˆ°å†²çªçš„éƒ¨åˆ†éƒ½éœ€è¦åœ¨å‘½åä¸ŠåŠ ä¸Šå›¢é˜Ÿè‡ªå·±çš„å‘½åç©ºé—´é¿å…å†²çª
4. `Favor Native Browser Features over Custom APIs` -- å°½é‡ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ api
5. `Build a Resilient Site` -- è®©ç½‘ç«™å°½å¯èƒ½ä¿æŒé«˜å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨`js`å‡ºç°å¼‚å¸¸çš„æ—¶å€™ä¹Ÿåº”å½“å°½å¯èƒ½ä¿è¯ç½‘ç«™åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œï¼Œä»¥åŠä½¿ç”¨åŒæ„æ¸²æŸ“å’Œæ¸è¿›å¢å¼ºæ¥æé«˜æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

ä»¥ä¸Šè¿™äº”ç‚¹å°±æ˜¯å¾®å‰ç«¯çš„æ ¸å¿ƒæ€æƒ³ï¼Œå¯ä»¥çœ‹å‡ºæ¥éƒ½æ˜¯åœ¨å›´ç»•å…¶åŸºæœ¬æ¦‚å¿µå»å®æ–½çš„ï¼Œéƒ½æ˜¯æ—¨åœ¨ä¿è¯å„æ¨¡å—ä¹‹é—´çš„ç‹¬ç«‹æ€§

ä¸‹é¢æˆ‘ä»¬ä¼šé€šè¿‡ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹æ¥ä½“éªŒä¸€ä¸‹å¾®å‰ç«¯çš„æ¶æ„æ€æƒ³ï¼Œçœ‹çœ‹å’Œä¼ ç»Ÿçš„å¼€å‘æ€è·¯æœ‰ä½•ä¸åŒ

# ç®€æ˜“æ˜é‡‘å•†åŸæ¡ˆä¾‹ -- ä¼ ç»Ÿæ–¹æ¡ˆ

é¦–å…ˆæˆ‘ä»¬ç”¨ä¼ ç»Ÿçš„å¼€å‘æ€è·¯å»å®ç°ä¸€ä¸ªç®€æ˜“çš„æ˜é‡‘å•†åŸï¼Œå…ˆçœ‹çœ‹å®ƒçš„æœ€ç»ˆæ•ˆæœï¼š

![æ˜é‡‘å•†åŸæ¼”ç¤º.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/998347d57a134480ade59faeceb608fe~tplv-k3u1fbpfcp-watermark.image?)

å¹¶ä¸”è¿˜åšäº†æ·±æµ…æ¨¡å¼çš„è¯†åˆ«ï¼Œä¸Šé¢çš„æ˜¯æ·±è‰²æ¨¡å¼ä¸‹çš„æ˜¾å¼æ•ˆæœï¼Œå†çœ‹çœ‹æµ…è‰²æ¨¡å¼ä¸‹çš„æ•ˆæœ:

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ebacfd44048497eb686704d2870db71~tplv-k3u1fbpfcp-watermark.image?)

è¿˜åšäº†å“åº”å¼å¸ƒå±€ï¼Œå¯ä»¥åœ¨ç§»åŠ¨ç«¯æµè§ˆ:

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccda28e373ea439ea15fd68f8be0b431~tplv-k3u1fbpfcp-watermark.image?)

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/479ccdb318854a50a5cadd72ca482c73~tplv-k3u1fbpfcp-watermark.image?)

å®ƒçš„åŠŸèƒ½åŒ…æ‹¬:

1. åˆ‡æ¢å•†å“æ—¶ï¼Œå•†å“è¯¦æƒ…å’Œå…³è”å•†å“ä¹Ÿä¼šç›¸åº”åˆ‡æ¢
2. åˆ‡æ¢å•†å“æ—¶ï¼Œè´­ä¹°å•†å“æŒ‰é’®çš„ä»·æ ¼ä¹Ÿä¼šç›¸åº”åˆ‡æ¢
3. è´­ä¹°å•†å“æ—¶ï¼Œä¼šå°†å•†å“åŠ å…¥åˆ°è´­ç‰©è½¦ä¸­ï¼Œè´­ç‰©è½¦æ•°é‡çŠ¶æ€ä¼šæ”¹å˜

å°±å®ç°è¿™ä¹ˆä¸‰ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œé€šè¿‡è¿™ä¸ªç®€å•çš„æ¡ˆä¾‹æ¥æ„Ÿå—ä¸‹ä¼ ç»Ÿå¼€å‘æ€è·¯å’Œå¾®å‰ç«¯æ¶æ„çš„å·®å¼‚

## ç›®å½•ç»“æ„

å…ˆçœ‹çœ‹ç”¨ä¼ ç»Ÿçš„åŸç”Ÿå¼€å‘çš„æ–¹å¼å®ç°è¿™æ ·çš„ä¸€ä¸ªç®€å•æ¡ˆä¾‹çš„ç›®å½•ç»“æ„:

```plain
.
â”œâ”€â”€ apps                                                  // å­˜æ”¾æ‰€æœ‰åº”ç”¨
â”‚   â””â”€â”€ juejin-store                                      // æ˜é‡‘å•†åŸåº”ç”¨
â”‚       â”œâ”€â”€ event-listeners.ts
â”‚       â”œâ”€â”€ images                                        // å›¾ç‰‡èµ„æº
â”‚       â”‚   â”œâ”€â”€ juejin-bytedance-coffee-vaccum-cup.png
â”‚       â”‚   â”œâ”€â”€ juejin-canvas-bag.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-coffee-cup.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-dupont-bag-1.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-dupont-bag-2.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-mug.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-phone-holder-boss-talk.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-phone-holder-bug-clearing.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-phone-holder-get-off-work.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-phone-holder-happy-working.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-vaccum-cup.jpg
â”‚       â”‚   â”œâ”€â”€ juejin-woven-bag.jpg
â”‚       â”‚   â””â”€â”€ no-data.png
â”‚       â”œâ”€â”€ index.ts                                      // æ˜é‡‘å•†åŸåº”ç”¨å…¥å£
â”‚       â”œâ”€â”€ model.ts                                      // ç”¨åˆ°çš„æ•°æ®æ¨¡å‹å’Œç›¸å…³æŸ¥è¯¢å‡½æ•°
â”‚       â”œâ”€â”€ renderer.ts                                   // æ¸²æŸ“å™¨å®ç°æ ¸å¿ƒæ¸²æŸ“é€»è¾‘
â”‚       â”œâ”€â”€ styles                                        // æ˜é‡‘å•†åŸæ ·å¼
â”‚       â”‚   â”œâ”€â”€ index.ts                                  // ç»Ÿä¸€å¯¼å…¥æ ·å¼æ–‡ä»¶
â”‚       â”‚   â””â”€â”€ main.scss                                 // ä¸»æ ·å¼å…¥å£
â”‚       â”œâ”€â”€ types                                         // ç±»å‹å£°æ˜æ–‡ä»¶ç›®å½•
â”‚       â”‚   â”œâ”€â”€ app.d.ts                                  // åº”ç”¨ç›¸å…³çš„ç±»å‹å£°æ˜
â”‚       â”‚   â”œâ”€â”€ product.d.ts                              // å•†å“ç›¸å…³çš„ç±»å‹å£°æ˜
â”‚       â”‚   â””â”€â”€ renderer.d.ts                             // æ¸²æŸ“å™¨ç›¸å…³çš„ç±»å‹å£°æ˜
â”‚       â””â”€â”€ utils                                         // å·¥å…·å‡½æ•°
â”‚           â””â”€â”€ index.ts
â”œâ”€â”€ main.ts                                               // vite é¡¹ç›®å…¥å£
â”œâ”€â”€ style                                                 // é¡¹ç›®æ•´ä½“çš„æ ·å¼
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ main.scss
â”‚   â”œâ”€â”€ variables-dark.scss                               // æ·±è‰²æ¨¡å¼ä¸‹çš„ scss å˜é‡
â”‚   â””â”€â”€ variables-light.scss                              // æµ…è‰²æ¨¡å¼ä¸‹çš„ scss å˜é‡
â””â”€â”€ vite-env.d.ts
```

è¿™ä¸ªç›®å½•ç»“æ„å°†æ˜é‡‘å•†åŸè¿™ä¸ªåº”ç”¨æ”¾åˆ°äº†å•ç‹¬çš„ç›®å½•ä¸­ç®¡ç†ï¼Œå°†æ¯ä¸ªç³»ç»Ÿè§†ä¸ºä¸€ä¸ª`app`(è™½ç„¶åªæœ‰ä¸€ä¸ª app)ï¼Œé¡¹ç›®éœ€è¦ä½¿ç”¨å“ªä¸ª`app`å°±ç›´æ¥è°ƒç”¨`app`æä¾›çš„`setup`å‡½æ•°å³å¯(åé¢ä»£ç è®²è§£å¯ä»¥çœ‹åˆ°)

## å…¥å£ä»£ç åˆ†æ

### setupApp

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä¸ª`vite`é¡¹ç›®çš„å…¥å£`src/main.ts`

```ts
import setupJuejinStore from './apps/juejin-store'
import './style'

const $app = document.querySelector<HTMLDivElement>('#app')!

const setupApp = ($app: App) => {
  setupJuejinStore($app)
}

setupApp($app)
```

æˆ‘çš„è®¾è®¡ç†å¿µæ˜¯æ¯ä¸ªåº”ç”¨éƒ½æä¾›è‡ªå·±çš„`setup`å‡½æ•°ï¼Œå³ä¾¿æ˜¯é¡¹ç›®ä¸»å…¥å£ä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨é¡¹ç›®ä¸»å…¥å£ä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ª`setupApp`çš„å‡½æ•°ï¼Œå°†å®¹å™¨å…ƒç´ ä¼ å…¥åå°±èƒ½å¤Ÿå°†åº”ç”¨æŒ‚è½½åˆ°è¿™ä¸ªå®¹å™¨å…ƒç´ ä¸­ï¼Œå®Œæˆæ¸²æŸ“

å¯ä»¥çœ‹åˆ°`setupApp`é‡Œé¢è°ƒç”¨äº†`setupJuejinStore`ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹`setupJuejinStore`è¦åšå“ªäº›äº‹æƒ…å§

### setupJuejinStore

`src/apps/juejin-store/index.ts`

```ts
import createRenderer from './renderer'
import './styles'

function setupJuejinStore($app: App) {
  const { run } = createRenderer($app)

  run()
}

export default setupJuejinStore
```

å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå°±åœ¨äº`createRenderer`ï¼Œè°ƒç”¨åæ‹¿åˆ°å®ƒçš„`run`æ–¹æ³•å³å¯å¯åŠ¨æˆ‘ä»¬çš„æ˜é‡‘å•†åŸåº”ç”¨ï¼Œæ‰€ä»¥æ¯ä¸ªåº”ç”¨çš„æ ¸å¿ƒå°±åœ¨äºå®ƒçš„æ¸²æŸ“å™¨çš„å®ç°

æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬çš„é‡å¿ƒå°±æ”¾åœ¨æ¸²æŸ“å™¨çš„éƒ¨åˆ†

## æ¸²æŸ“å™¨å®ç°

æ¸²æŸ“å™¨çš„æ ¸å¿ƒå°±åœ¨äºæ¸²æŸ“å‡½æ•°`render`çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨`render`å‡½æ•°ä¸­å°†åº”ç”¨çš„`html`æ¡†æ¶å†™å…¥åˆ°å®¹å™¨å…ƒç´ `$app`ä¸­

é¦–å…ˆæˆ‘ä»¬çš„æ¸²æŸ“é€»è¾‘ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªçŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯å½“å‰å±•ç¤ºçš„å•†å“çš„`id`ï¼Œä¸€ä¸ªæ˜¯è´­ç‰©è½¦ä¸­å•†å“çš„æ•°é‡

```ts
interface IState {
  // å½“å‰å±•ç¤ºçš„å•†å“ id
  productId: number
  // è´­ç‰©è½¦ä¸­å•†å“æ•°é‡
  basketCount: number
}

const state: IState = {
  productId: 1,
  basketCount: 0,
}
```

ç„¶åå°±æ˜¯æ¸²æŸ“å‡½æ•°çš„å®ç°

```ts
function render() {
  // è·å–å½“å‰å±•ç¤ºçš„å•†å“
  const product = getProductById(state.productId)

  $app.innerHTML = `
    <section class="juejin-store">
      <!-- æ ‡é¢˜ -->
      <h1 class="title">æ˜é‡‘å•†åŸ</h1>

      <!-- è´­ç‰©è½¦ -->
      <section class="basket">è´­ç‰©è½¦ï¼š${state.basketCount} ä»¶</section>

      <!-- å•†å“å›¾ç‰‡é¢„è§ˆ -->
      <section class="previewer">
        <img src="${loadImage(product?.cover ?? 'no-data.png')}" alt="${
    product?.name ?? 'æœªçŸ¥å•†å“'
  }" />
      </section>

      <!-- å•†å“å -->
      <h3 class="product-name">${product?.name ?? 'æœªçŸ¥å•†å“'}</h3>

      <!-- å•†å“åˆ—è¡¨ -->
      <section class="product-list">${renderProductList()}</section>

      <!-- è´­ä¹°æŒ‰é’® -->
      <button class="purchase-btn">è´­ä¹°: ${product?.price ?? 66666} ï¿¥</button>

      <!-- å…³è”å•†å“ -->
      <section class="related-products">
        <h3>å…³è”å•†å“</h3>

        <!-- å…³è”å•†å“åˆ—è¡¨ -->
        <section class="related-product-list">${
          product && renderRelatedProductList(product)
        }</section>
      </section>
    </section>
    `
}
```

æˆ‘ä»¬ä½¿ç”¨`ES6`çš„æ¨¡æ¿å­—ç¬¦ä¸²ç‰¹æ€§èƒ½å¤Ÿå¾ˆå¥½çš„è®©æˆ‘ä»¬åœ¨`html`ä¸­æ’å…¥æ•°æ®

è€Œå•†å“åˆ—è¡¨å’Œå…³è”å•†å“åˆ—è¡¨è¿™ç§éœ€è¦å¾ªç¯æ¸²æŸ“æ•°æ®çš„åœºæ™¯ï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯å°†å®ƒä»¬çš„é€»è¾‘æŠ½ç¦»åˆ°å•ç‹¬çš„æ¸²æŸ“å‡½æ•°ä¸­å»å®Œæˆ

## æ¸²æŸ“å•†å“åˆ—è¡¨å’Œå…³è”å•†å“åˆ—è¡¨

`renderProductList`çš„å®ç°å¦‚ä¸‹

```ts
/**
 * @description æ¸²æŸ“å•†å“åˆ—è¡¨
 * @param displayProductList å±•ç¤ºåœ¨å•†å“åˆ—è¡¨ä¸­çš„å•†å“
 */
function renderProductList(): string {
  const displayProductList = getDisplayProductList()
  const renderProductItem = (product: IProduct): string => {
    const active = product.id === state.productId
    return `
        <div class="product-list-item ${active ? 'active' : ''}" >
          <img src="${loadImage(product.cover)}" alt="${
      product.name
    }" data-product-id="${product.id}" />
        </div>
      `
  }

  return displayProductList.map(renderProductItem).join('')
}
```

`renderRelatedProductList`çš„å®ç°å¦‚ä¸‹:

```ts
/**
 * @description æ¸²æŸ“å•†å“çš„å…³è”å•†å“
 * @param product å•†å“
 */
function renderRelatedProductList(product: IProduct): string {
  const renderRelatedProductItem = (relatedProduct: IProduct): string => {
    return `
        <div class="related-product-list-item">
          <img src="${loadImage(relatedProduct.cover)}" alt="${
      relatedProduct.name
    }" data-product-id="${relatedProduct.id}" />
        </div>
      `
  }

  return getRelatedProducts(product.id)
    .map(relatedProduct =>
      relatedProduct ? renderRelatedProductItem(relatedProduct) : '',
    )
    .join('')
}
```

å¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯å°†åˆ—è¡¨é¡¹çš„æ¸²æŸ“é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œä¸€æ¬¡æ€§è¿”å›æ•°ç»„çš„æ¸²æŸ“ç»“æœï¼Œè¿™æ ·åœ¨ä¸»æ¸²æŸ“å‡½æ•°ä¸­é˜…è¯»èµ·æ¥ä¼šæ›´åŠ æ¸…æ™°ï¼Œæé«˜ä»£ç å¯è¯»æ€§

## å·¥å…·å‡½æ•°

å¯¹äºå›¾ç‰‡çš„æ¸²æŸ“ï¼Œéœ€è¦å…ˆåŠ è½½å‡ºå®ƒçš„`url`ï¼Œå†å°†å…¶èµ‹å€¼åˆ°`<img>`çš„`src`å±æ€§ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æœ‰ä¸€ä¸ªå·¥å…·å‡½æ•°æ¥å°†å›¾ç‰‡èµ„æºåŠ è½½æˆ`url`ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æ¸²æŸ“å‡½æ•°ä¸­çš„`loadImage`ï¼Œåªè¦ä¼ å…¥`src/apps/juejin-store/images`ç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶åå³å¯è·å¾—å®ƒçš„`url`

```ts
/**
 * @description åŠ è½½ images/ ç›®å½•ä¸‹çš„å›¾ç‰‡åä¸º url
 * @param imageName images/ ç›®å½•ä¸‹çš„å›¾ç‰‡å
 */
function loadImage(imageName: string) {
  const imagePath = `../images/${imageName}`
  const url = new URL(imagePath, import.meta.url).href

  return url
}

export { loadImage }
```

## å•†å“æ•°æ®æ¨¡å‹ä»¥åŠç›¸å…³æŸ¥è¯¢å‡½æ•°

ä¸Šé¢`render`å‡½æ•°ä¸­çš„æ•°æ®éƒ½æ¥è‡ªäº`model.ts`ä¸­ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¹¶æ²¡æœ‰æ¥å…¥åç«¯ï¼Œè€Œæ˜¯è‡ªå·±æ¨¡æ‹Ÿäº†ä¸€äº›å›ºå®šæ•°æ®ï¼Œ`model.ts`çš„ä»£ç å¦‚ä¸‹:

```ts
const products: IProduct[] = [
  // ============ æ¯å­å“ç±» ============
  {
    id: 1,
    name: 'JUEJIN FRIENDS ã€Œç èµ›å…‹ã€ç å…‹æ¯',
    price: 69,
    cover: 'juejin-mug.jpg',
    displayInList: true,
    relatedProducts: [2, 3, 4],
  },
  {
    id: 2,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€Œæˆ‘çœŸçš„ä¸å›°ã€å’–å•¡æ¯',
    price: 119,
    cover: 'juejin-coffee-cup.jpg',
    displayInList: false,
    relatedProducts: [1, 3, 4],
  },
  {
    id: 3,
    name: 'è™è™ç”Ÿé‡‘ç³»åˆ—-ä¿æ¸©æ¯',
    price: 129,
    cover: 'juejin-vaccum-cup.jpg',
    displayInList: false,
    relatedProducts: [1, 2, 4],
  },
  {
    id: 4,
    name: 'å­—èŠ‚å’–å•¡ä¿æ¸©æ¯',
    price: 129,
    cover: 'juejin-bytedance-coffee-vaccum-cup.png',
    displayInList: false,
    relatedProducts: [1, 2, 3],
  },

  // ============ æ‰‹æœºæ”¯æ¶å“ç±» ============
  {
    id: 5,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€ŒæŒºä½ ã€æ‰‹æœºæ”¯æ¶/æ¡Œé¢çŠ¶æ€æ  -- å¼€å¿ƒæ‰“å·¥ä¸­',
    price: 39.9,
    cover: 'juejin-phone-holder-happy-working.jpg',
    displayInList: true,
    relatedProducts: [6, 7, 8],
  },
  {
    id: 6,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€ŒæŒºä½ ã€æ‰‹æœºæ”¯æ¶/æ¡Œé¢çŠ¶æ€æ  -- Boss Talk',
    price: 39.9,
    cover: 'juejin-phone-holder-boss-talk.jpg',
    displayInList: false,
    relatedProducts: [5, 7, 8],
  },
  {
    id: 7,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€ŒæŒºä½ ã€æ‰‹æœºæ”¯æ¶/æ¡Œé¢çŠ¶æ€æ  -- Bug æ¸…é™¤ä¸­',
    price: 39.9,
    cover: 'juejin-phone-holder-bug-clearing.jpg',
    displayInList: false,
    relatedProducts: [5, 6, 8],
  },
  {
    id: 8,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€ŒæŒºä½ ã€æ‰‹æœºæ”¯æ¶/æ¡Œé¢çŠ¶æ€æ  -- å·²ä¸‹ç­å‹¿ Cue',
    price: 39.9,
    cover: 'juejin-phone-holder-get-off-work.jpg',
    displayInList: false,
    relatedProducts: [5, 6, 7],
  },

  // ============ åŒ…å“ç±» ============
  {
    id: 9,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€Œä¸¢æ‰åŒ…è¢±ã€æœé‚¦ç‰¹åŒ…',
    price: 119,
    cover: 'juejin-dupont-bag-1.jpg',
    displayInList: true,
    relatedProducts: [10, 11, 12],
  },
  {
    id: 10,
    name: 'ç¨€åœŸæ˜é‡‘â€”Who Caresç³»åˆ—ã€Œä¸¢æ‰åŒ…è¢±ã€æœé‚¦ç‰¹åŒ…',
    price: 119,
    cover: 'juejin-dupont-bag-2.jpg',
    displayInList: false,
    relatedProducts: [9, 11, 12],
  },
  {
    id: 11,
    name: 'ç¨€åœŸæ˜é‡‘ã€Œç¡çœ æ—¥ç³»åˆ—ã€ç¼–ç»‡è¢‹',
    price: 69,
    cover: 'juejin-woven-bag.jpg',
    displayInList: false,
    relatedProducts: [9, 10, 12],
  },
  {
    id: 12,
    name: 'ç¨€åœŸæ˜é‡‘-ã€Œè§£ç ç³»åˆ—ã€çš®é©å¸†å¸ƒè¢‹',
    price: 99,
    cover: 'juejin-canvas-bag.jpg',
    displayInList: false,
    relatedProducts: [9, 10, 11],
  },
]

/**
 * @description æ ¹æ®å•†å“ id è·å–å•†å“å¯¹è±¡
 * @param id å•†å“ id
 * @returns IProduct
 */
const getProductById = (id: ProductId) => {
  return products.find(product => product.id === id)
}

/**
 * @description è·å–å•†å“çš„å…³è”å•†å“
 * @param id å•†å“ id
 */
const getRelatedProducts = (id: ProductId): (IProduct | undefined)[] => {
  const product = getProductById(id)

  if (product) {
    return product.relatedProducts.map(getProductById)
  }

  return []
}

/**
 * @description è·å–å±•ç¤ºåœ¨å•†å“åˆ—è¡¨ä¸­çš„å•†å“ -- å³ displayInList å±æ€§ä¸º true çš„å•†å“
 */
const getDisplayProductList = () => {
  return products.filter(product => product.displayInList)
}

export { products, getProductById, getRelatedProducts, getDisplayProductList }
```

## äº‹ä»¶å¤„ç†

ä»¥ä¸Šä»£ç å®Œæˆåä»…ä»…æ˜¯å®ç°äº†`ui`éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¿˜æœ‰é‡è¦çš„äº‹ä»¶é€»è¾‘è¦å®Œæˆï¼Œä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘å°†äº‹ä»¶ç›¸å…³çš„é€»è¾‘æŠ½ç¦»æˆå•ç‹¬çš„`event-listeners.ts`æ–‡ä»¶ä¸­å»ç»´æŠ¤

å›å¿†ä¸€ä¸‹å‰é¢çš„éœ€æ±‚åˆ†æï¼Œæˆ‘ä»¬éœ€è¦å®ç°çš„äº‹ä»¶é€»è¾‘ä¸€å…±æœ‰ä¸‰ä¸ª:

1. ç‚¹å‡»å•†å“åˆ—è¡¨çš„å•†å“ï¼Œä¼šåˆ‡æ¢å½“å‰å±•ç¤ºå•†å“çš„`id`ï¼Œä¹Ÿå°±æ˜¯æ¶‰åŠåˆ°ä¿®æ”¹æ¸²æŸ“å™¨ä¸­çš„`state`
2. ç‚¹å‡»å…³è”å•†å“åˆ—è¡¨ä¸­çš„å•†å“ï¼Œä¹Ÿä¼šåˆ‡æ¢å½“å‰å±•ç¤ºå•†å“çš„`id`
3. ç‚¹å‡»è´­ä¹°æŒ‰é’®ï¼Œä¼šå¢åŠ æ¸²æŸ“å™¨`state`ä¸­è´­ç‰©è½¦å•†å“æ•°é‡

é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆå†™å‡ºä»¥ä¸‹ä¸‰ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°

```ts
/**
 * @description ç‚¹å‡»å•†å“åˆ—è¡¨é¡¹åˆ‡æ¢å•†å“
 */
function handleChangeProduct(e: MouseEvent) {
  const productId = Number((e.target as HTMLImageElement).dataset.productId!)

  // ä¿®æ”¹ state.productId ä¸ºè§¦å‘äº‹ä»¶çš„å•†å“å…ƒç´ çš„ id
}

/**
 * @description è´­ä¹°å•†å“
 */
function handlePurchaseProduct() {
  // ä¿®æ”¹ state.basketCount è®©å…¶ +1
}

/**
 * @description ç‚¹å‡»å…³è”å•†å“æ—¶åˆ‡æ¢è‡³å…³è”å•†å“çš„è¯¦æƒ… -- é€»è¾‘ä¸å•†å“åˆ—è¡¨ä¸­çš„å•†å“åˆ‡æ¢ä¸€è‡´
 */
const handleRelatedProductClick = handleChangeProduct
```

### äº‹ä»¶å¤„ç†å‡½æ•°çš„é—®é¢˜

è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜:

1. äº‹ä»¶å¤„ç†å‡½æ•°ä¸­éœ€è¦ä¿®æ”¹æ¸²æŸ“å™¨ä¸­çš„`state`
2. `state`è¢«ä¿®æ”¹åï¼Œè§†å›¾åº”å½“æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¦é‡æ–°æ‰§è¡Œæ¸²æŸ“å‡½æ•°

ä½†æ˜¯ç›®å‰æˆ‘ä»¬çš„äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ˜¯æ— æ³•å’Œæ¸²æŸ“å™¨ç»“åˆçš„ï¼Œä¹Ÿå°±æ— æ³•è·å–åˆ°æ¸²æŸ“å™¨çš„`state`ä»¥åŠ`render`

é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†äº‹ä»¶å¤„ç†å‡½æ•°å…¨éƒ½å°è£…åˆ°ä¸€ä¸ª`createEventListeners`å‡½æ•°ä¸­ï¼Œå¹¶ä¸”è®©è¿™ä¸ªå‡½æ•°æ¥æ”¶æ¸²æŸ“å™¨çš„`state`å’Œ`render`

```ts
interface Options {
  state: IState
  render: Function
}

function createEventListeners({ state, render }: Options) {
  /**
   * @description ç‚¹å‡»å•†å“åˆ—è¡¨é¡¹åˆ‡æ¢å•†å“
   */
  function handleChangeProduct(e: MouseEvent) {
    const productId = Number((e.target as HTMLImageElement).dataset.productId!)

    state.productId = productId
    render()
  }

  /**
   * @description è´­ä¹°å•†å“
   */
  function handlePurchaseProduct() {
    state.basketCount++
    render()
  }

  /**
   * @description ç‚¹å‡»å…³è”å•†å“æ—¶åˆ‡æ¢è‡³å…³è”å•†å“çš„è¯¦æƒ… -- é€»è¾‘ä¸å•†å“åˆ—è¡¨ä¸­çš„å•†å“åˆ‡æ¢ä¸€è‡´
   */
  const handleRelatedProductClick = handleChangeProduct
}

export default createEventListeners
```

è¿™æ ·å°±å°†äº‹ä»¶å¤„ç†å‡½æ•°å’Œæ¸²æŸ“å™¨å…³è”èµ·æ¥äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦æŠŠäº‹ä»¶å¤„ç†å‡½æ•°ç»‘å®šåˆ°ç›¸å…³å…ƒç´ ä¸Š

### ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°

```ts
function createEventListeners({ state, render }: Options) {
  function addEventListeners() {
    const $productList = document.querySelector<HTMLElement>('.product-list')!
    const $purchaseBtn =
      document.querySelector<HTMLButtonElement>('.purchase-btn')!
    const $relatedProductList = document.querySelector<HTMLElement>(
      '.related-product-list',
    )!

    $productList.addEventListener('click', handleChangeProduct)
    $purchaseBtn.addEventListener('click', handlePurchaseProduct)
    $relatedProductList.addEventListener('click', handleRelatedProductClick)
  }

  /**
   * @description ç‚¹å‡»å•†å“åˆ—è¡¨é¡¹åˆ‡æ¢å•†å“
   */
  function handleChangeProduct(e: MouseEvent) {
    const productId = Number((e.target as HTMLImageElement).dataset.productId!)

    state.productId = productId
    render()
  }

  /**
   * @description è´­ä¹°å•†å“
   */
  function handlePurchaseProduct() {
    state.basketCount++
    render()
  }

  /**
   * @description ç‚¹å‡»å…³è”å•†å“æ—¶åˆ‡æ¢è‡³å…³è”å•†å“çš„è¯¦æƒ… -- é€»è¾‘ä¸å•†å“åˆ—è¡¨ä¸­çš„å•†å“åˆ‡æ¢ä¸€è‡´
   */
  const handleRelatedProductClick = handleChangeProduct
}
```

ç»‘å®šæ˜¯ç»‘å®šä¸Šäº†ï¼Œä½†æ˜¯è¿™é‡Œçš„`addEventListeners`æ²¡è¢«è°ƒç”¨å•Šï¼Œè¯¥åœ¨å“ªé‡Œè¢«è°ƒç”¨å‘¢ï¼Ÿ

åº”å½“å°†å…¶æ”¾åˆ°æ¸²æŸ“å™¨ä¸­çš„`run`æ–¹æ³•ä¸­è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†`addEventListeners`å‡½æ•°æš´éœ²å‡ºå»ï¼Œä»è€Œèƒ½å¤Ÿåœ¨æ¸²æŸ“å™¨ä¸­é€šè¿‡è°ƒç”¨`createEventListeners`åè·å–åˆ°

```ts
function createEventListeners({ state, render }: Options) {
  function addEventListeners() {
    // ...
  }

  // ...

  return {
    addEventListeners,
  }
}

export default createEventListeners
```

ä¿®æ”¹æ¸²æŸ“å™¨ï¼Œè°ƒç”¨`createEventListeners`è·å–åˆ°`addEventListeners`å‡½æ•°

```ts
function createRenderer($app: App) {
  const { addEventListeners } = createEventListeners({
    state,
    render,
  })

  function run() {
    render()
    addEventListeners()
  }

  return {
    run,
  }

}

export defalut createRenderer
```

### è¿›ä¸€æ­¥ä¼˜åŒ–

åœ¨æ¯ä¸€æ¬¡é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬çš„æ¸²æŸ“å‡½æ•°æ˜¯ç›´æ¥ä¿®æ”¹`$app`å®¹å™¨å…ƒç´ çš„`innerHTML`çš„ï¼Œè¿™æ ·ç®€å•ç²—æš´çš„å®ç°ä¼šå¯¼è‡´å·²æ³¨å†Œçš„äº‹ä»¶å¤„ç†å‡½æ•°å¤±æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ä¹‹å‰ç§»é™¤å·²æ³¨å†Œçš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¹¶åœ¨æ¸²æŸ“åå†æ¬¡æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•°

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„æ¸²æŸ“å™¨è¿˜éœ€è¦æä¾›ä¸€ä¸ª`rerender`æ–¹æ³•ï¼Œå…¶å†…å®¹å¦‚ä¸‹

```ts
function rerender() {
  removeEventListeners()
  render()
  addEventListeners()
}
```

ä½†æ˜¯æˆ‘ä»¬ç›®å‰åªèƒ½è·å–åˆ°`addEventListeners`ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®ç°`removeEventListeners`ï¼Œå®ƒçš„é€»è¾‘å’Œ`addEventListeners`ä¸€æ ·ï¼Œåªæ˜¯å˜æˆäº†ç§»é™¤äº‹ä»¶å¤„ç†å‡½æ•°è€Œå·²

```ts
function removeEventListeners() {
  const $productList = document.querySelector<HTMLElement>('.product-list')!
  const $purchaseBtn =
    document.querySelector<HTMLButtonElement>('.purchase-btn')!
  const $relatedProductList = document.querySelector<HTMLElement>(
    '.related-product-list',
  )!

  $productList.removeEventListener('click', handleChangeProduct)
  $purchaseBtn.removeEventListener('click', handlePurchaseProduct)
  $relatedProductList.removeEventListener('click', handleRelatedProductClick)
}
```

`addEventListeners`çš„ä»£ç å’Œ`removeEventListener`æœ‰å¤§é‡é‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é‡æ„ä¸€ä¸‹

```ts
// æ·»åŠ æˆ–è€…ç§»é™¤äº‹ä»¶ç›‘å¬å‡½æ•°
function manageEventListeners(mode: 'add' | 'remove') {
  const $productList = document.querySelector<HTMLElement>('.product-list')!
  const $purchaseBtn =
    document.querySelector<HTMLButtonElement>('.purchase-btn')!
  const $relatedProductList = document.querySelector<HTMLElement>(
    '.related-product-list',
  )!

  const manage = mode === 'add' ? 'addEventListener' : 'removeEventListener'

  $productList[manage]('click', handleChangeProduct as any)
  $purchaseBtn[manage]('click', handlePurchaseProduct)
  $relatedProductList[manage]('click', handleRelatedProductClick as any)
}

function addEventListeners() {
  manageEventListeners('add')
}

function removeEventListeners() {
  manageEventListeners('remove')
}
```

### è®©å¼€å‘ä½“éªŒæ›´åƒ react

ä¸ºäº†è®©ä½“éªŒæ›´åƒ`react`ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†å¯¹`state`çš„ä¿®æ”¹å˜æˆ`setState`ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¸²æŸ“å™¨ä¸­æä¾›ä¸€ä¸ª`setState`æ–¹æ³•

```ts
/**
 * @description æ›´æ–° state
 * @param cb æ›´æ–° state çš„å›è°ƒ
 */
const setState: SetState = cb => {
  cb(state)
}
```

å®ƒçš„ç±»å‹å®šä¹‰å¦‚ä¸‹:

```ts
type SetStateCallback = (state: IState) => void
type SetState = (cb: SetStateCallback) => void
```

æŠ½ç¦»è¿™ä¸ªç±»å‹å®šä¹‰æ˜¯ä¸ºäº†åœ¨`event-listeners.ts`çš„`Options`æ¥å£ä¸­å£°æ˜ï¼Œæ¯•ç«Ÿå®ƒä»¬æ˜¯åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­

```ts
interface Options {
  setState: SetState
  rerender: () => void
}
```

ç°åœ¨äº‹ä»¶å¤„ç†å‡½æ•°å°±å˜æˆäº†è¿™æ ·:

```ts
/**
 * @description ç‚¹å‡»å•†å“åˆ—è¡¨é¡¹åˆ‡æ¢å•†å“
 */
function handleChangeProduct(e: MouseEvent) {
  const productId = Number((e.target as HTMLImageElement).dataset.productId!)

  setState(state => {
    state.productId = productId
  })

  rerender()
}

/**
 * @description è´­ä¹°å•†å“
 */
function handlePurchaseProduct() {
  setState(state => state.basketCount++)

  rerender()
}

/**
 * @description ç‚¹å‡»å…³è”å•†å“æ—¶åˆ‡æ¢è‡³å…³è”å•†å“çš„è¯¦æƒ… -- é€»è¾‘ä¸å•†å“åˆ—è¡¨ä¸­çš„å•†å“åˆ‡æ¢ä¸€è‡´
 */
const handleRelatedProductClick = handleChangeProduct
```

è‡³æ­¤è¿™ä¸ªå°æ¡ˆä¾‹å°±å®Œæˆå•¦ï¼Œæ ·å¼éƒ¨åˆ†çš„ä»£ç å°±ä¸å±•ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åˆ°æˆ‘çš„ä»“åº“ä¸­æŸ¥çœ‹æºç ï¼Œå¦‚æœè§‰å¾—ä¸é”™çš„è¯æ¬¢è¿ç‚¹ä¸ª star~

> æºç : https://github.com/Plasticine-Yang/micro-frontends-demo/tree/main/0-juejin-store

# ç®€æ˜“æ˜é‡‘å•†åŸæ¡ˆä¾‹ -- å¾®å‰ç«¯æ–¹æ¡ˆ

## æ€è€ƒå¾®å‰ç«¯æ¶æ„éœ€è¦è§£å†³çš„é—®é¢˜

å‰é¢æˆ‘ä»¬ç”¨ä¼ ç»Ÿæ–¹æ¡ˆå¼€å‘çš„æ˜é‡‘å•†åŸä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜:

1. æ‰€æœ‰çš„`html`éƒ½æ˜¯ç”±å®¢æˆ·ç«¯çš„`js`åŠ¨æ€ç”Ÿæˆçš„ï¼Œä¹Ÿå°±æ˜¯çº¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œè¿™ä¸åˆ©äº`SEO`å¹¶ä¸”å¯èƒ½å­˜åœ¨é¦–å±ç™½å±æ—¶é—´è¿‡é•¿çš„é—®é¢˜(æœ¬é¡¹ç›®ä¸­é€»è¾‘ç®€å•ï¼Œä¸å­˜åœ¨ç™½å±å¾ˆé•¿çš„æƒ…å†µï¼Œä½†æ”¾åˆ°è§„æ¨¡å¤§ä¸€äº›çš„é¡¹ç›®ä¸­æ¥çœ‹å°±ä¸ä¸€æ ·äº†)
2. åªè¦`state`æ•°æ®å‘ç”Ÿæ”¹å˜å°±ä¼šå¯¼è‡´æ•´ä¸ªé¡µé¢é‡æ–°æ¸²æŸ“ï¼Œæ²¡æœ‰ä»»ä½•çš„`diff`ç®—æ³•ä¼˜åŒ–è¿›è¡Œå±€éƒ¨æ›´æ–°ï¼Œæ¯”å¦‚ç‚¹å‡»è´­ä¹°çš„æ—¶å€™åªéœ€è¦ä¿®æ”¹è´­ç‰©è½¦çŠ¶æ€å¯¹åº”çš„è§†å›¾å³å¯ï¼Œæ²¡å¿…è¦ä¿®æ”¹å•†å“åˆ—è¡¨å’Œå…³è”å•†å“ä¸­çš„å†…å®¹ï¼Œä½†ä¼ ç»Ÿæ–¹æ¡ˆå®ç°ä¸­æ˜¯ç®€å•ç²—æš´åœ°ç›´æ¥è°ƒç”¨`rerender`è¿›è¡Œå…¨éƒ¨å†…å®¹çš„é‡æ–°æ¸²æŸ“çš„
3. æ‰€æœ‰ä»£ç éƒ½æ˜¯åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ç»´æŠ¤çš„ï¼Œæ²¡æœ‰æ‹†åˆ†æˆä¸åŒæ¨¡å—å¹¶äº¤ç”±ä¸åŒå›¢é˜Ÿå»è´Ÿè´£

ä¸ºäº†è§£å†³ä»¥ä¸Šå‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å¾®å‰ç«¯çš„æ¶æ„æ€æƒ³æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå…³äºç¬¬ä¸€ä¸ªé—®é¢˜å¯ä»¥ç”±æœåŠ¡ç«¯æ¸²æŸ“æ¥è§£å†³ï¼Œä½†è¿™ä¸ªä¸æ˜¯é‡ç‚¹ï¼Œæˆ‘ä»¬å…ˆä»ç„¶ä½¿ç”¨å®¢æˆ·ç«¯æ¸²æŸ“çš„æ–¹å¼è¿›è¡Œå¼€å‘

### é¡¹ç›®æ¨¡å—æ‹†åˆ†

ä¸ºäº†èƒ½å¤Ÿè®©ä¸åŒå›¢é˜Ÿæ¥è´Ÿè´£ä¸åŒæ¨¡å—ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†æ•´ä¸ªæ˜é‡‘å•†åŸæ‹†åˆ†æˆä¸åŒçš„æ¨¡å—ï¼Œæ‹†åˆ†ç»“æœå¦‚ä¸‹:

![æ¨¡å—æ‹†åˆ†.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae0551fa0b95466b822c186a6eead379~tplv-k3u1fbpfcp-watermark.image?)

çº¢è‰²æ¡†åœˆä½çš„æ˜¯æ•´ä¸ªä¸»åº”ç”¨ï¼Œä¸»åº”ç”¨å†³å®šäº†æ•´ä¸ªé¡¹ç›®æœ‰å“ªäº›åŠŸèƒ½ä»¥åŠåº”ç”¨çš„æ•´ä½“å¸ƒå±€ï¼Œä¸»åº”ç”¨è´Ÿè´£å±•ç¤ºå•†å“çš„å°é¢å›¾ç‰‡ï¼Œå•†å“åå’Œå•†å“åˆ—è¡¨ï¼Œè€Œå•†å“çš„è´­ä¹°å’Œå…³è”å•†å“åˆ™æ‹†åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„æ¨¡å—åº”ç”¨ï¼Œæ¨¡å—åº”ç”¨æœ‰ç‹¬ç«‹çš„å›¢é˜Ÿå»è´Ÿè´£å®ç°

æ¨¡å—åº”ç”¨ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ¨¡å—æä¾›çš„äº§ç‰©æ˜¯`WebComponent`ï¼Œè¿™æ ·å°±èƒ½å¤Ÿåœ¨æ¨¡å—åº”ç”¨åŠ è½½å®Œæ¯•åç›´æ¥åœ¨ä¸»åº”ç”¨ä¸­ç»„åˆä½¿ç”¨å„ä¸ªæ¨¡å—ï¼Œæ¨¡å—ä¹‹é—´çš„éƒ¨ç½²å¯ä»¥æ˜¯ç‹¬ç«‹çš„ï¼Œåªè¦ä¿è¯èƒ½å¤Ÿåœ¨ä¸»åº”ç”¨ä¸­è·å–åˆ°æ¨¡å—åº”ç”¨çš„éƒ¨ç½²äº§ç‰©å³å¯

æ¯ä¸ªæ¨¡å—éƒ½ç”±ç‹¬ç«‹çš„å›¢é˜Ÿè´Ÿè´£ï¼Œä¸ºäº†åŒºåˆ†ä¸åŒå›¢é˜Ÿï¼Œæˆ‘ä»¬çº¦å®šä¸€ä¸‹å…³è”å•†å“æ¨¡å—çš„å›¢é˜Ÿåä¸º`foo`ï¼Œè´­ä¹°å•†å“æ¨¡å—çš„å›¢é˜Ÿåä¸º`bar`

### å…¶ä»–é—®é¢˜

å¾®å‰ç«¯æ¶æ„æœ€é‡è¦çš„æ˜¯æ€è€ƒå¦‚ä½•è§£å†³ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜:

1. æ¨¡å—ä¹‹é—´`js`éš”ç¦»æœºåˆ¶
2. é¿å…`css`æ ·å¼å†²çª
3. æŒ‰éœ€åŠ è½½èµ„æº
4. åœ¨å›¢é˜Ÿä¹‹é—´å…±äº«å…¬å…±èµ„æº
5. å¤„ç†å¼‚æ­¥æ•°æ®çš„è·å–ä»¥åŠä¸ºç”¨æˆ·è€ƒè™‘è‰¯å¥½çš„åŠ è½½çŠ¶æ€

æ˜ç™½äº†å¤§è‡´æ€è·¯åï¼Œå°±éœ€è¦è€ƒè™‘ä¸‹å¦‚ä½•å°†é¡¹ç›®è¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†æˆå¯ä»¥ç‹¬ç«‹å­˜åœ¨çš„å¤šä¸ªæ¨¡å—åº”ç”¨

## ä¸»åº”ç”¨

é¦–å…ˆæˆ‘ä»¬æ¥å®ç°ä¸»åº”ç”¨ï¼Œæ ¸å¿ƒåœ¨äºæ¸²æŸ“å™¨çš„å®ç°ï¼Œç›´æ¥å‚è€ƒä¼ ç»Ÿæ–¹æ¡ˆä¸­çš„æ¸²æŸ“å™¨å®ç°ï¼Œå¹¶æŠŠè´­ä¹°ç›¸å…³çš„æ¸²æŸ“å’Œå…³è”å•†å“ç›¸å…³çš„æ¸²æŸ“ç§»é™¤ï¼Œç„¶åæ”¹ä¸ºå¼•ç”¨ç›¸åº”æ¨¡å—æä¾›çš„`WebComponent Custom Elements`çš„æ–¹å¼ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹:

```ts
function render() {
  // è·å–å½“å‰å±•ç¤ºçš„å•†å“
  const product = getProductById(state.productId)

  $app.innerHTML = `
    <section class="juejin-store">
      <!-- æ ‡é¢˜ -->
      <h1 class="title">æ˜é‡‘å•†åŸ</h1>

      <!-- è´­ç‰©è½¦ -->
      <bar-basket class="basket"></bar-basket>

      <!-- å•†å“å›¾ç‰‡é¢„è§ˆ -->
      <section class="previewer">
        <img src="${loadImage(product?.cover ?? 'no-data.png')}" alt="${
    product?.name ?? 'æœªçŸ¥å•†å“'
  }" />
      </section>

      <!-- å•†å“å -->
      <h3 class="product-name">${product?.name ?? 'æœªçŸ¥å•†å“'}</h3>

      <!-- å•†å“åˆ—è¡¨ -->
      <section class="product-list">${renderProductList()}</section>

      <!-- è´­ä¹°æŒ‰é’® -->
      <bar-purchase-btn class="purchase-btn"></bar-purchase-btn>

      <!-- å…³è”å•†å“ -->
      <foo-related-products class="related-products"></foo-related-products>
    </section>
    `
}
```

æ³¨æ„ï¼Œä¸ºäº†é˜²æ­¢å›¢é˜Ÿä¹‹é—´è‡ªå®šä¹‰å…ƒç´ çš„å‘½åå†²çªï¼Œæˆ‘ä»¬è¦éµå®ˆå‰é¢æåˆ°çš„å¾®å‰ç«¯æ¶æ„èƒŒåçš„æ ¸å¿ƒæ€æƒ³ï¼Œæ³¨å†Œå’Œä½¿ç”¨è‡ªå®šä¹‰å…ƒç´ æ—¶éƒ½éœ€è¦åŠ ä¸Šå›¢é˜Ÿåå‰ç¼€ä»¥ç¤ºåŒºåˆ†

ç°åœ¨æˆ‘ä»¬çš„ä¸»åº”ç”¨å°±å°†å•†å“çš„è´­ä¹°é€»è¾‘å’Œå…³è”å•†å“çš„é€»è¾‘ç‹¬ç«‹å‡ºå»äº†ï¼Œåªéœ€è¦ç­‰ç›¸åº”å›¢é˜Ÿå¼€å‘å®Œæˆåå°†ä»–ä»¬æä¾›çš„`WebComponent`æ³¨å†Œåˆ°ä¸»åº”ç”¨ä¸­å³å¯

å®Œæ•´ä»£ç å¯ä»¥åˆ°æˆ‘çš„ä»“åº“ä¸­æŸ¥çœ‹ï¼Œè¿™é‡Œæ›´å¤šçš„æ˜¯ä»£ç ç»“æ„ä¸Šçš„è°ƒæ•´ï¼Œä»£ç å†…å®¹å¤§è‡´ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œå°±ä¸è´´å‡ºæ¥äº†

> æºç : https://github.com/Plasticine-Yang/micro-frontends-demo/tree/main/1-composition-client-only/main-app

## foo å›¢é˜Ÿ -- å…³è”å•†å“æ¨¡å—åº”ç”¨

`foo`å›¢é˜Ÿçš„ä¸»è¦ä»»åŠ¡å°±æ˜¯å®Œæˆå…³è”å•†å“æ¨¡å—ï¼Œæˆ‘ä»¬ä»¥`CustomElements`çš„æ–¹å¼å»å®ç°ï¼Œæœ€ç»ˆæ³¨å†Œåˆ°å…¨å±€å³å¯

```ts
import { getProductById, getRelatedProducts } from './model'
import { loadImage } from './utils'

class FooRelatedProducts extends HTMLElement {
  // è¢«è§‚å¯Ÿçš„æ•°æ®åœ¨æ›´æ–°æ—¶ä¼šè§¦å‘ attributeChangedCallback å›è°ƒ
  static get observedAttributes() {
    return ['product-id']
  }

  // å…ƒç´ è¢«æ³¨å†Œæ—¶ä¼šè°ƒç”¨è¯¥é’©å­
  connectedCallback() {
    const product = this.getProduct()
    this.log(`connected! product: ${product}`)
    this.render()
  }

  // product-id æ›´æ–°æ—¶é‡æ–°æ¸²æŸ“å¯¹åº”çš„å…³è”å•†å“
  attributeChangedCallback(
    attrName: string,
    oldValue: string,
    newValue: string,
  ) {
    this.log(`attr changed: ${attrName} -- from ${oldValue} to ${newValue}`)

    switch (attrName) {
      case 'product-id':
        this.render()
        break
    }
  }

  // æ ¹æ®è°ƒç”¨è€…ä¼ å…¥çš„ prop: å•†å“ id æ¥è·å–å•†å“å¯¹è±¡
  getProduct() {
    const productId = this.getAttribute('product-id')

    if (productId) {
      const product = getProductById(Number(productId))
      return product
    }

    return null
  }

  // html æ¨¡æ¿
  template() {
    const product = this.getProduct()

    const template = document.createElement('template')
    template.innerHTML = `
      <style>
        .related-product-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-top: 20px;
        }

        .related-product-list-item {
          cursor: pointer;

          img {
            width: 100%;
            border-radius: 20px;
          }
        }
      </style>

      <section>
        <h3>å…³è”å•†å“</h3>

        <!-- å…³è”å•†å“åˆ—è¡¨ -->
        <section class="related-product-list">${
          product && this.renderRelatedProductList(product)
        }</section>
      </section>
      `

    return template.content.cloneNode(true)
  }

  /**
   * @description æ¸²æŸ“å•†å“çš„å…³è”å•†å“
   * @param product å•†å“
   */
  renderRelatedProductList(product: IProduct): string {
    const renderRelatedProductItem = (relatedProduct: IProduct): string => {
      return `
        <div class="related-product-list-item">
          <img src="${loadImage(relatedProduct.cover)}" alt="${
        relatedProduct.name
      }" data-product-id="${relatedProduct.id}" />
        </div>
      `
    }

    return getRelatedProducts(product.id)
      .map(relatedProduct =>
        relatedProduct ? renderRelatedProductItem(relatedProduct) : '',
      )
      .join('')
  }

  render() {
    const clonedTemplateNode = this.template()

    this.attachShadow({ mode: 'closed' })
    this.shadowRoot!.appendChild(clonedTemplateNode)
  }

  log(...args: any[]) {
    console.log('team-foo', ...args)
  }
}

// å°†è‡ªå®šä¹‰å…ƒç´ æ³¨å†Œåˆ°å…¨å±€
window.customElements.define('foo-related-products', FooRelatedProducts)

export default FooRelatedProducts
```

å…³äº`CustomElements`çš„ä½¿ç”¨å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„è¿™ç¯‡æ–‡ç« ï¼Œé‡Œé¢æœ‰è¯¦ç»†çš„ä»‹ç»

> [ğŸ‘‰ Custom Elements -- åŸç”Ÿ JS å®ç°ç»„ä»¶åŒ– WebComponent çš„åŸºçŸ³](https://juejin.cn/post/7151788510691721224)

## bar å›¢é˜Ÿ -- å•†å“è´­ä¹°æ¨¡å—åº”ç”¨

è‡³äº `bar` å›¢é˜Ÿï¼Œåˆ™è´Ÿè´£è´­ä¹°å•†å“çš„æŒ‰é’®ä»¥åŠè´­ç‰©è½¦åŠŸèƒ½ï¼Œä¸ºæ­¤ï¼Œè¦æä¾›ä¸¤ä¸ªè‡ªå®šä¹‰å…ƒç´ 

`è´­ä¹°å•†å“æŒ‰é’®`

```ts
import { getProductById } from '../model'
import { state } from '../state'

class PurchaseBtn extends HTMLElement {
  private attachedShadowRoot: ShadowRoot | null = null

  // è¢«è§‚å¯Ÿçš„æ•°æ®åœ¨æ›´æ–°æ—¶ä¼šè§¦å‘ attributeChangedCallback å›è°ƒ
  static get observedAttributes() {
    return ['product-id']
  }

  // å…ƒç´ è¢«æ³¨å†Œæ—¶ä¼šè°ƒç”¨è¯¥é’©å­
  connectedCallback() {
    const product = this.getProduct()
    this.log(`connected! product: ${product}`)
    this.render()
    this.attachedShadowRoot?.addEventListener('click', this.addToBasket)
  }

  disconnectedCallback() {
    this.attachedShadowRoot?.removeEventListener('click', this.addToBasket)
  }

  // product-id æ›´æ–°æ—¶é‡æ–°æ¸²æŸ“å¯¹åº”çš„å…³è”å•†å“
  attributeChangedCallback(
    attrName: string,
    oldValue: string,
    newValue: string,
  ) {
    this.log(`attr changed: ${attrName} -- from ${oldValue} to ${newValue}`)

    switch (attrName) {
      case 'product-id':
        this.render()
        break
    }
  }

  // æ ¹æ®è°ƒç”¨è€…ä¼ å…¥çš„ prop: å•†å“ id æ¥è·å–å•†å“å¯¹è±¡
  getProduct() {
    const productId = this.getAttribute('product-id')

    if (productId) {
      const product = getProductById(Number(productId))
      return product
    }

    return null
  }

  /**
   * @description æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ -- è‡ªå¢ state.basketCount å¹¶æ´¾å‘è‡ªå®šä¹‰äº‹ä»¶ bar:basket:changed
   */
  addToBasket() {
    state.basketCount++
    this.log('æ´¾å‘è‡ªå®šä¹‰äº‹ä»¶: bar:basket:changed')
    this.dispatchEvent(
      new CustomEvent('bar:basket:changed', {
        bubbles: true,
      }),
    )
  }

  // html æ¨¡æ¿
  template() {
    const product = this.getProduct()

    const template = document.createElement('template')
    template.innerHTML = `
      <button>è´­ä¹°: ${product?.price ?? 66666} ï¿¥</button>
      `

    return template.content.cloneNode(true)
  }

  render() {
    const clonedTemplateNode = this.template()

    this.attachedShadowRoot = this.attachShadow({ mode: 'closed' })
    this.attachedShadowRoot.appendChild(clonedTemplateNode)
  }

  log(...args: any[]) {
    console.log('team-bar', ...args)
  }
}

export default PurchaseBtn
```

`è´­ç‰©è½¦`

```ts
import { state } from '../state'

class Basket extends HTMLElement {
  // å…ƒç´ è¢«æ³¨å†Œæ—¶ä¼šè°ƒç”¨è¯¥é’©å­
  connectedCallback() {
    // this.refresh ä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°è¢«è°ƒç”¨æ—¶ this ä¼šä¸¢å¤± æ‰€ä»¥éœ€è¦æ˜¾å¼ç»‘å®šä¸€ä¸‹ this
    this.refresh = this.refresh.bind(this)
    this.render()
    window.addEventListener('bar:basket:changed', this.refresh)
  }

  disconnectedCallback() {
    window.removeEventListener('bar:basket:changed', this.refresh)
  }

  // html æ¨¡æ¿
  template() {
    const template = document.createElement('template')
    template.innerHTML = `
      <section>è´­ç‰©è½¦ï¼š${state.basketCount} ä»¶</section>
    `

    return template.content.cloneNode(true)
  }

  render() {
    const clonedTemplateNode = this.template()

    this.attachShadow({ mode: 'closed' }).appendChild(clonedTemplateNode)
  }

  refresh() {
    this.log('æ¥æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶: bar:basket:changed')
    this.render()
  }

  log(...args: any[]) {
    console.log('team-bar', ...args)
  }
}

export default Basket
```

æœ€åè¿˜è¦è®°å¾—æ³¨å†Œè‡ªå®šä¹‰å…ƒç´ 

```ts
window.customElements.define('bar-purchase-btn', PurchaseBtn)
window.customElements.define('bar-basket', Basket)
```

è¿™æ ·æˆ‘ä»¬å°±ç®—æ˜¯ä½“éªŒäº†ä¸€ä¸‹å¾®å‰ç«¯æ¶æ„ä¸‹çš„ä¸€ä¸ªå¼€å‘æ–¹å¼å•¦ï¼Œå½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªåˆæ­¥åœ°æ¢ç´¢ï¼Œæ›´æ·±å…¥çš„å†…å®¹è¿˜æ˜¯éœ€è¦å¤§å®¶å»[micro-frontends.org](https://micro-frontends.org/)ä¸­ç ”ç©¶ä¸€ä¸‹~
